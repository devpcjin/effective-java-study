## Java8 Concurrent í”„ë¡œê·¸ë˜ë°

[[Java]ë©€í‹°í”„ë¡œì„¸ìŠ¤ì™€ ë©€í‹°ìŠ¤ë ˆë“œ](https://velog.io/@nnakki/Java%EB%A9%80%ED%8B%B0%EC%8A%A4%EB%A0%88%EB%93%9C)
[[Java]ìŠ¤ë ˆë“œ(Thread)
](https://velog.io/@nnakki/JavaìŠ¤ë ˆë“œThread)
[[Java]ìŠ¤ë ˆë“œí’€(Thread Pool)
](https://velog.io/@nnakki/JavaìŠ¤ë ˆë“œí’€Thread-Pool)
### Executorì™€ ThreadPool
  - Executor í”„ë ˆì„ì›Œí¬ì™€ ì“°ë ˆë“œí’€ì„ í†µí•´ì„œ ì“°ë ˆë“œì˜ í˜ì„ ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ ëŒì–´ ì˜¬ë¦¬ëŠ” íƒœìŠ¤í¬ ì œì¶œê³¼ ì‹¤í–‰ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µ

### Threadì˜ ë¬¸ì œ
  - Java ìŠ¤ë ˆë“œëŠ” ì§ì  ìš´ì˜ì²´ì œ ìŠ¤ë ˆë“œì— ì ‘ê·¼
  - ìš´ì˜ì²´ì œ ìŠ¤ë ˆë“œëŠ” ë§Œë“¤ê³  ì¢…ë£Œí•˜ëŠ”ë°ì— ìˆì–´ ë¹„ìš©ì´ ë¹„ìŒˆ
  - ë˜í•œ ìŠ¤ë ˆë“œ ìˆ«ìëŠ” ì œí•œë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ìš´ì˜ì²´ì œê°€ ì§€ì›í•˜ëŠ” ìŠ¤ë ˆë“œ ì´ˆê³¼ ì‚¬ìš©ì‹œ ì¶©ëŒ ë°œìƒ ê°€ëŠ¥ 
  
### ThreadPool ì˜ ì¥ì 
  - Javaì˜ `executorService`	ëŠ” Taskë¥¼ ì œì¶œí•˜ê³  ë‚˜ì¤‘ì— ê²°ê³¼ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ìˆ˜ì§‘
  - í”„ë¡œê·¸ë¨ì€ `newFixedThreadPool`ê³¼ ê°™ì€ íŒ©í† ë¦¬ ë©”ì†Œë“œ ì¤‘ í•˜ë‚˜ë¥¼ ì´ìš©í•˜ì—¬, Thread Poolì„ ë§Œë“¤ì–´ì„œ ì‚¬ìš©
`nTreads`ë¥¼ í¬í•¨í•˜ëŠ” `ExecutorService`ë¥¼ ë§Œë“¤ê³ , ì´ë¥¼ ThreadPoolì— ì €ì¥
  - í•˜ë“œì›¨ì–´ì— ë§ëŠ” íƒœìŠ¤í¬ë¥¼ ìœ ì§€í•¨ê³¼ ë™ì‹œì— ìˆ˜ ì²œê°œì˜ Taskë¥¼ ì•„ë¬´ ì˜¤ë²„í—¤ë“œ ì—†ì´ ì œì¶œ ê°€ëŠ¥ 
  
### ThreadPoolì˜ ë¬¸ì œì 
  1. Kê°œì˜ ìŠ¤ë ˆë“œë¥¼ ê°€ì§„ í’€ì€ ì˜¤ì§ kë§Œí¼ì˜ ìŠ¤ë ˆë“œë¥¼ ë™ì‹œì— ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. ì´ˆê³¼ë¡œ ì œì¶œëœ íƒœìŠ¤í¬ëŠ” Queueì— ì €ì¥ë˜ë©°, ì´ì „ì— íƒœìŠ¤í¬ ì¤‘ í•˜ë‚˜ê°€ ì¢…ë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” ìŠ¤ë ˆë“œì— í• ë‹¹í•˜ì§€ ì•ŠëŠ”ë‹¤.
  ![](https://velog.velcdn.com/images/nnakki/post/ddf6da4b-8d74-45c2-a200-04d02f36c215/image.png)
> Sleep ìƒíƒœë‚˜ I/Oë¥¼ ê¸°ë‹¤ë¦¬ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” íƒœìŠ¤í¬ê°€ ìˆì„ ê²½ìš° ì£¼ì˜í•´ì•¼í•œë‹¤.
í•´ë‹¹ ì‘ì—…ì´ ë°œìƒí•˜ëŠ” ê²½ìš° íƒœìŠ¤í¬ê°€ ì›Œì»¤ ìŠ¤ë ˆë“œì— í• ë‹¹ ëœ ìƒíƒœë¥¼ ìœ ì§€í•˜ì§€ë§Œ ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠëŠ”ë‹¤.
(Wasteí•œ ìƒíƒœê°€ ë˜ê³  ìµœì•…ì˜ ê²½ìš° Deadlock(ë‘ ê°œ ì´ìƒì˜ ì‘ì—…ì´ ì„œë¡œê°€ ëë‚˜ê¸°ë§Œì„ ê¸°ë‹¤ë¦¬ëŠ” êµì°©ìƒíƒœ)ë°œìƒ)
  2. ì¤‘ìš”í•œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ìŠ¤ë ˆë“œê°€ ì£½ì§€ ì•Šë„ë¡, JavaëŠ” Mainì„ ë°˜í™˜í•˜ê¸° ì „ ëª¨ë“  ìŠ¤ë ˆë“œì˜ ì‘ì—…ì´ ëë‚˜ê¸¸ ê¸°ë‹¤ë¦°ë‹¤. -> **í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ê¸° ì „ ëª¨ë“  ì“°ë ˆë“œí’€ì„ ì¢…ë£Œí•˜ëŠ” ìŠµê´€ì´ í•„ìš”
**
------------
## ë™ì‹œì„±ì„ êµ¬í˜„í•˜ëŠ” ìë°”ì˜ ì§„í™”

| ë²„ì „ | ì‚¬ìš©ë°©ë²• |
| :---| :---|
|java5ì´ì „| Runnableê³¼ Threadë¥¼ ì´ìš©í•˜ì—¬ êµ¬í˜„|
|Java5 | ExecutorService, Callable<T>, Future<T>|
|java7|Fork/Join , RecursiveTask|
|java8|Steam, CompletableFuture|
|java9|ë¶„ì‚° ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì€ ëª…ì‹œì ìœ¼ë¡œ ì§€ì›(ë°œí–‰ êµ¬ë… í”„ë¡œí† ì½œ ì§€ì› Flow API)|

> 
  #### ë™ê¸°ì‹ ì²˜ë¦¬ (Synchronous)
ì§ë ¬ì ìœ¼ë¡œ taskë¥¼ ìˆ˜í–‰í•œë‹¤. ì¦‰, íƒœìŠ¤í¬ëŠ” ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° ì–´ë–¤ ì‘ì—…ì´ ìˆ˜í–‰ì¤‘ì´ë©´ ë‹¤ìŒ ì‘ì—…ì€ ëŒ€ê¸°í•œë‹¤.![](https://velog.velcdn.com/images/nnakki/post/255005cf-2678-4ac0-8e53-11e7d82cf394/image.png)
  #### ë¹„ë™ê¸°ì‹ ì²˜ë¦¬ (Asynchronous)
ë³‘ë ¬ì ìœ¼ë¡œ taskë¥¼ ìˆ˜í–‰í•œë‹¤. ì¦‰, íƒœìŠ¤í¬ê°€ ì¢…ë£Œë˜ì§€ ì•Šì€ ìƒíƒœë¼ í•˜ë”ë¼ë„ ëŒ€ê¸°í•˜ì§€ ì•Šê³  ë‹¤ìŒ íƒœìŠ¤í¬ë¥¼ ì‹¤í–‰í•œë‹¤.![](https://velog.velcdn.com/images/nnakki/post/e194eb28-7ced-433c-8c84-6ea0dfc392f4/image.png)
>
Future í˜•ì‹ì˜ APIëŠ” ì¼íšŒì„±ì˜ ê°’ì„ ì²˜ë¦¬í•˜ëŠ” ë° ì í•©í•˜ê³ , 
ë¦¬ì•¡í‹°ë¸Œ í˜•ì‹ì˜ ë¹„ë™ê¸° APIëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì¼ë ¨ì˜ ê°’ì„ ì²˜ë¦¬í•˜ëŠ”ë° ì í•©í•˜ë‹¤.
  >
  #### ë™ê¸° APIì™€ ë¹„ë™ê¸° API
>
ì „í†µì ì¸ ë™ê¸° API ì—ì„œëŠ” ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œ ë‹¤ìŒì— ë©”ì†Œë“œê°€ ê³„ì‚°ì„ ì™„ë£Œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë©”ì†Œë“œê°€ ë°˜í™˜ë˜ë©´ í˜¸ì¶œìëŠ” ë°˜í™˜ëœ ê°’ìœ¼ë¡œ ê³„ì† ë‹¤ë¥¸ ë™ì‘ì„ ìˆ˜í–‰í•œë‹¤. í˜¸ì¶œìì™€ í”¼í˜¸ì¶œìê°€ ê°ê° ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ìƒí™©ì´ì—ˆë”ë¼ë„, í˜¸ì¶œìëŠ” í”¼í˜¸ì¶œìì˜ ë™ì‘ ì™„ë£Œë¥¼ ê¸°ë‹¤ë ¸ì„ ê²ƒì´ë‹¤. ì´ì²˜ëŸ¼ ë™ê¸° APIë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒí™©ì„ ë¸”ë¡ í˜¸ì¶œ ì´ë¼ê³  í•œë‹¤.
>
ë°˜ë©´ ë¹„ë™ê¸° API ì—ì„œëŠ” ë©”ì†Œë“œê°€ ì¦‰ì‹œ ë°˜í™˜ë˜ë©°, ëë‚´ì§€ ëª»í•œ ë‚˜ë¨¸ì§€ ì‘ì—…ì„ í˜¸ì¶œì ìŠ¤ë ˆë“œì™€ ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì— í• ë‹¹í•œë‹¤. ì´ì™€ê°™ì€ ë¹„ë™ê¸° APIë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒí™©ì„ ë¹„ë¸”ë¡ í˜¸ì¶œì´ë¼ê³  í•œë‹¤. ë‹¤ë¥¸ ìŠ¤ë ˆë“œì— í• ë‹¹ëœ ë‚˜ë¨¸ì§€ ê³„ì‚° ê²°ê³¼ëŠ” ì½œë°± ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ì„œ ì „ë‹¬í•˜ê±°ë‚˜ í˜¸ì¶œìê°€ ê³„ì‚°ê²°ê³¼ë¥¼ ëë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ ë©”ì†Œë“œë¥¼ ì¶”ê°€ë¡œ í˜¸ì¶œí•˜ë©´ì„œ ì „ë‹¬ëœë‹¤.

------------------------------------
  
## CompletableFuture
ìë°”ì—ì„œ ë¹„ë™ê¸°(Asynchronous) í”„ë¡œê·¸ë˜ë°ì„ ê°€ëŠ¥í•˜ê²Œí•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
  
- Futureë¡œëŠ” í•˜ê¸° ì–´ë ¤ìš´ ì‘ì—…ë“¤ 
	- Futureë¥¼ ì™¸ë¶€ì—ì„œ ì™„ë£Œ ì‹œí‚¬ ìˆ˜ ì—†ë‹¤. ì·¨ì†Œí•˜ê±°ë‚˜, get()ì— íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•  ìˆ˜ëŠ” ìˆë‹¤.
	- ë¸”ë¡œí‚¹ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ì„œëŠ” ì‘ì—…ì´ ëë‚¬ì„ ë•Œ ì½œë°±ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ë‹¤.
    - ì—¬ëŸ¬ Futureë¥¼ ì¡°í•©í•  ìˆ˜ ì—†ë‹¤. ex) Event ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ ë‹¤ìŒ, Eventì— ì°¸ì„í•˜ëŠ” íšŒì› ê°€ì ¸ì˜¤ê¸°
    - ì˜ˆì™¸ ì²˜ë¦¬ìš© APIë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.
  ----
  
ex) ğŸ”»Futureë¥¼ ë‹¨ìˆœ í™œìš©í•œ ë¹„ë™ê¸°
```java
ExecutorService executor = Executors.newCachedThreadPool();
Future<Double> future = executor.submit(new Callable<double>() {
  public Double call() {
    return doSomeLongComputation();// ì‹œê°„ì´ ì˜¤ë˜ê±¸ë¦¬ëŠ” Task
  }
});
doSomethingElse(); // ë¹„ë™ê¸° ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë™ì•ˆ ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰.
try {
  Double result = future.get(1,TimeUnit.SECONDS);
} catch(ExecutionException ee){
  // ê³„ì‚° ì¤‘ ì˜ˆì™¸ ë°œìƒ
} catch (InterruptedException ie){
  // í˜„ì¬ ìŠ¤ë ˆë“œì—ì„œ ëŒ€ê¸° ì¤‘ ì¸í„°ëŸ½íŠ¸ ë°œìƒ
} catch (TimeoutException te){
  // Futureê°€ ì™„ë£Œë˜ê¸° ì „ì— íƒ€ì„ì•„ì›ƒ ë°œìƒ
}  
```
`ExecutorService`ê°€ ì œê³µí•˜ëŠ” ìŠ¤ë ˆë“œê°€ ì‹œê°„ì´ ì˜¤ë˜ê±¸ë¦¬ëŠ” ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ë™ì•ˆ, ë©”ì¸ ìŠ¤ë ˆë“œë¡œ ë‹¤ë¥¸ ì‘ì—…ì„ ë™ì‹œì— ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. ë‹¤ë¥¸ ì‘ì—…ì„ ì²˜ë¦¬í•˜ë‹¤ê°€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ì˜ ê²°ê³¼ê°€ í•„ìš”í•œ ì‹œì ì— get()ì„ ì‚¬ìš©í•˜ì—¬ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¨ë‹¤. get ë©”ì†Œë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ, ì´ë¯¸ ê³„ì‚°ì´ ì™„ë£Œë˜ì–´ ê²°ê³¼ê°€ ì¤€ë¹„ ë˜ì—ˆë‹¤ë©´, ì¦‰ì‹œ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ì§€ë§Œ ê²°ê³¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ë”°ë©´ ì‘ì—…ì´ ì™„ë£Œë  ë•Œ ê¹Œì§€ ìŠ¤ë ˆë“œë¥¼ ë¸”ë¡ì‹œí‚¨ë‹¤. 
  ![](https://velog.velcdn.com/images/nnakki/post/404603f5-16d8-42de-aa25-b47e980f3b4a/image.png)
  
  > âš  ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ì´ ì˜ì›íˆ ëë‚˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ì‘ì—…ì´ ì˜ì›íˆ Blockë  ìˆ˜ ìˆë‹¤.
 
  ---
## ë¹„ë™ê¸°ë¡œ ì‘ì—… ì‹¤í–‰í•˜ê¸°
 - ### runAsync() - ë¦¬í„´ê°’ì´ ì—†ëŠ”ê²½ìš°
```java
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
    });

    future.get(); 
```
- ### supplyAsync() - ë¦¬í„´ê°’ì´ ìˆëŠ” ê²½ìš°
```java
    CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    });

    System.out.println(future.get());
```
  
## ì½œë°± ì œê³µí•˜ê¸°
 - ### thenApply(Function) - ë¦¬í„´ ê°’ì´ ìˆì„ ë•Œ
```java
    CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    }).thenApply((s) -> {
        System.out.println(Thread.currentThread().getName());
        return s.toUpperCase();
    });

    System.out.println(future.get());  
```
  
- ### thenAccept(Consumer) - ë¦¬í„´ ê°’ì´ ì—†ì„ ë•Œ
```java
    CompletableFuture<Void> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    }).thenAccept((s) -> {
        System.out.println(Thread.currentThread().getName());
        System.out.println(s.toUpperCase());
    });

    future.get();  
```
- ### thenRun(Runnable) - ë¦¬í„´ê°’ì„ ë°›ì§€ ì•Šê³ , ë‹¤ë¥¸ ì‘ì—…ì„ ì²˜ë¦¬
```java
    CompletableFuture<Void> future = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    }).thenRun(() -> {
        System.out.println(Thread.currentThread().getName());
    });

    future.get();  
```  
## ì¡°í•©í•˜ê¸°
### thenCompose() - ë‘ ì‘ì—…ì´ ì„œë¡œ ì´ì–´ì„œ ì‹¤í–‰í•˜ë„ë¡ ì¡°í•©
```java
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        CompletableFuture<String> hello = CompletableFuture.supplyAsync(() -> {
            System.out.println("Hello: " + Thread.currentThread().getName());
            return "Hello";
        });
        CompletableFuture<String> future = hello.thenCompose(App::getWorld);

        System.out.println(future.get());
    }

    private static CompletableFuture<String> getWorld(String message) {
        return CompletableFuture.supplyAsync(() -> {
            System.out.println("World: " + Thread.currentThread().getName());
            return message + " World";
        });
    }
```  
### themCombine() - ë‘ ì‘ì—…ì„ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ë‘˜ë‹¤ ì¢…ë£Œ í–ˆì„ ë•Œ ì½œë°± ì‹¤í–‰
```java
    CompletableFuture<String> hello = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    });

    CompletableFuture<String> world = CompletableFuture.supplyAsync(() -> {
        System.out.println("World: " + Thread.currentThread().getName());
        return "World";
    });

    CompletableFuture<String> future = hello.thenCombine(world, (h, w) -> h + " " + w);
    System.out.println(future.get());
```
### allOf() - ì—¬ëŸ¬ ì‘ì—…ì„ ëª¨ë‘ ì‹¤í–‰í•˜ê³ , ëª¨ë“  ì‘ì—… ê²°ê³¼ì— ì½œë°± ì‹¤í–‰
```java
    CompletableFuture<String> hello = CompletableFuture.supplyAsync(() -> {
        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    });

    CompletableFuture<String> world = CompletableFuture.supplyAsync(() -> {
        System.out.println("World: " + Thread.currentThread().getName());
        return "World";
    });
    List<CompletableFuture<String>> futures = Arrays.asList(hello, world);
    CompletableFuture[] futuresArray = futures.toArray(new CompletableFuture[futures.size()]);

    CompletableFuture<List<String>> result = CompletableFuture.allOf(futuresArray)
            .thenApply(v -> {
                return futures.stream()
                        .map(CompletableFuture::join)
                        .collect(Collectors.toList());
            });

    result.get().forEach(System.out::println);
```
### anyOf() - ê°€ì¥ ë¹¨ë¦¬ ëë‚œ í•˜ë‚˜ì˜ ê²°ê³¼ì— ì½œë°± ì‹¤í–‰
```java
    CompletableFuture<Void> future = CompletableFuture.anyOf(hello, world).thenAccept(System.out::println);
    future.get();
```
  
## ì˜ˆì™¸ì²˜ë¦¬
### exceptionally(Function)
```java
    boolean throwError = true;

    CompletableFuture<String> hello = CompletableFuture.supplyAsync(() -> {
        if(throwError){
            throw new IllegalArgumentException();
        }

        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    }).exceptionally(ex -> {
        System.out.println(ex);
        return "Error!";
    });

    System.out.println(hello.get());
```
### handle(BiFunction)
```java
    boolean throwError = true;

    CompletableFuture<String> hello = CompletableFuture.supplyAsync(() -> {
        if(throwError){
            throw new IllegalArgumentException();
        }

        System.out.println("Hello: " + Thread.currentThread().getName());
        return "Hello";
    }).handle((result, ex) -> {
        if (ex != null){
            System.out.println(ex);
            return "Error!";
        }
        return result;
    });

    System.out.println(hello.get());
```
  
